<!DOCTYPE html>
<html ng-app="SUSSApp" ng-controller="MainCtrl">
  <head>
    <title>Simple URL Shortener Service</title>
    <style>
      html {
        width: 100%;
        min-height: 100%;
        height: 100%;
        background: black;
        color: #0F0;
      }
      body {
        min-height: 100%;
      }
      .line {
        width: 97%;
        min-width: 97%;
      }
      span {
        width: auto;
        font-family: monospace;
      }
      pre {
      }
      input {
        width: 97%;
        font-size: large;
        padding: 0;
        border: none;
        border: 0;
        font-family: monospace;
        background: black;
        color: #0F0;
      }
    </style>
  </head>
  <body>
    <div ng-repeat="hist in local.history track by $index" class="line">
      <pre>{{hist}}</pre>
    </div>
    <form ng-hide="local.processing" class="line" ng-submit="handleInput()">
      <label for='in'>&gt; </label> 
      <input autocomplete="off" ng-trim="false" id="in" ng-model="local.input"></input>
      <input type="submit" ng-hide="true">
    </form>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.1/angular.min.js"></script>
    <script>
      var app = angular.module("SUSSApp", []);
      app.controller("MainCtrl", ['$scope','$http', function($scope, $http) {
        $scope.local = {};
        $scope.local.processing = false;
        $scope.local.history = ["Type 'help' for help"];
        $scope.local.input = "";

        var commands = {
          'help': function(args, cb) {
            if(args.length > 0) {
              switch(args[0]) {
                case 'help':
                  return cb("Gives help about a command: help <command>");
                case 'info':
                  return cb("Gives info about a short url: info esk.io/id");
                case 'shorten': 
                  return cb("Shortens a url: shorten longurl.tld")
                default:
                  return cb("Command " + args[0] + " not found");
              }
            } else {
              return cb("Comamnds are: help, shorten, info. Type help <command> for detailed help");
            }
          },
          'shorten': function(args, cb) {
            $http.post('/api/shorten', {url: args[0]})
              .success(function(data, status, headers, config) {
                if(data.error) return cb(data.error);
                else return cb("Url successfully shortened: " + data.shortUrl);
              })
              .error(function(data, status, headers, config) {
                cb("An unknown error occured");
              });
          },
          'info': function(args, cb) { 
            var id = args[0];
            if(/\//.test(id)) {
              var parts = id.split("/");
              id = parts[parts.length - 1];
            }
            $http.get('/api/info/' + id)
              .success(function(data, status, headers, config) {
                if(data.error) return cb(data.error);
                else return cb("The url lengthens to: " + data.longUrl);
              })
              .error(function(data, status, headers, config) {
                cb("An unknown error occured");
              });
          }
        };

        $scope.handleInput = function() {
          var text = $scope.local.input;
          if(angular.isUndefined(text)) text = "";

          $scope.local.input = ""; 

          $scope.local.history.push("> " + text);
          if(/^\s*$/.test(text)) return;

          var command = text.split(' ')[0];
          if(typeof commands[command] != "undefined") {
            $scope.local.processing = true;
            commands[command](text.split(' ').slice(1), function(text) {
              $scope.local.history.push(text);
              $scope.local.processing = false;
            });
          }
        };
        $scope.focusInput = function() {
          document.forms[0].elements[0].focus();
        };
        $scope.focusInput();
      }]);
    </script>
  </body>
</html>
